<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMS Crew Schedule</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
            background-image: radial-gradient(circle at top left, rgba(79, 70, 229, 0.2), transparent 30%),
                              radial-gradient(circle at bottom right, rgba(139, 92, 246, 0.15), transparent 40%);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .schedule-card {
            animation: fadeIn 0.5s ease-out forwards;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    </style>
</head>
<body class="bg-slate-900 text-gray-300 min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">
                EMS DAY SCHEDULE
            </h1>
            <p class="mt-2 text-lg text-slate-400">Upcoming Crew Assignments</p>
        </header>

        <div id="schedule-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div id="loading-state" class="col-span-1 md:col-span-2 lg:col-span-3 text-center p-12">
                 <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                 <p class="mt-4 text-slate-400 text-lg">Connecting to live database...</p>
            </div>
        </div>
        
        <div class="mt-12 text-center">
            <a href="./schedule_admin.html" class="text-slate-600 hover:text-indigo-400 text-sm transition-colors">Admin Login</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCqqW_fryqigzg7zDWgEsuADhBkPYcHQMo",
            authDomain: "db2-2f64c.firebaseapp.com",
            projectId: "db2-2f64c",
            storageBucket: "db2-2f64c.firebasestorage.app",
            messagingSenderId: "234811583682",
            appId: "1:234811583682:web:aa2bd4e29296207c0d5f5b",
            measurementId: "G-38MS80C490"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        };

        initAuth();

        const formatDate = (dateString) => {
            if(!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day); 
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const scheduleRef = collection(db, 'artifacts', appId, 'public', 'data', 'emsSchedule');
                
                onSnapshot(scheduleRef, (snapshot) => {
                    const container = document.getElementById('schedule-container');
                    container.innerHTML = ''; 
                    
                    // 1. Group individual entries by Date + Time
                    const groupedShifts = {};
                    const todayStr = new Date().toISOString().split('T')[0];

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        
                        // Only process future/today shifts
                        if (d.date >= todayStr) {
                            const key = `${d.date}_${d.time}`;
                            if (!groupedShifts[key]) {
                                groupedShifts[key] = {
                                    date: d.date,
                                    time: d.time,
                                    names: []
                                };
                            }
                            
                            // Handle both new 'name' field and legacy fields just in case
                            if (d.name) {
                                groupedShifts[key].names.push(d.name);
                            } else {
                                // Fallback for old schema
                                if (d.crewMember1) groupedShifts[key].names.push(d.crewMember1);
                                if (d.crewMember2) groupedShifts[key].names.push(d.crewMember2);
                                if (d.trainee) groupedShifts[key].names.push(`${d.trainee} (Trainee)`);
                            }
                        }
                    });

                    // 2. Convert Map to Array and Sort
                    const displayShifts = Object.values(groupedShifts).sort((a, b) => {
                        const dateComp = a.date.localeCompare(b.date);
                        if (dateComp !== 0) return dateComp;
                        return a.time.localeCompare(b.time);
                    });

                    // Limit to 9 items
                    const slicedShifts = displayShifts.slice(0, 9);

                    if (slicedShifts.length === 0) {
                         container.innerHTML = '<p class="col-span-full text-center text-slate-400 text-lg">No upcoming shifts scheduled.</p>';
                         return;
                    }

                    // 3. Render Cards
                    slicedShifts.forEach(row => {
                        const isToday = row.date === todayStr;
                        
                        // Sort names alphabetically within the shift
                        row.names.sort();

                        const card = `
                            <div class="schedule-card bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl shadow-lg transition-all duration-300 hover:border-indigo-500 hover:shadow-indigo-500/20 hover:-translate-y-1 ${isToday ? 'border-2 border-green-500 shadow-green-500/20' : ''}">
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <p class="text-2xl font-bold text-white">${formatDate(row.date)}</p>
                                            ${isToday ? '<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200 mt-1">Today</span>' : ''}
                                        </div>
                                        <div class="flex-shrink-0 flex items-center text-md font-medium text-slate-300 bg-slate-700/50 px-3 py-1 rounded-full">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            ${row.time || 'N/A'}
                                        </div>
                                    </div>
                                    <div class="border-t border-slate-700 my-4"></div>
                                    <div class="space-y-4 text-slate-300 text-lg">
                                        <p class="text-sm uppercase font-semibold text-indigo-400">Assigned Personnel</p>
                                        
                                        ${row.names.map(name => `
                                            <div class="flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                                <span>${name}</span>
                                            </div>
                                        `).join('')}
                                        
                                        ${row.names.length === 0 ? '<span class="text-slate-500 italic">No crew assigned</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', card);
                    });

                }, (error) => {
                    console.error("Data Listen Error:", error);
                    const container = document.getElementById('schedule-container');
                    container.innerHTML = '<div class="text-red-400 text-center col-span-full">Error loading schedule.</div>';
                });
            }
        });
    </script>
</body>
</html>